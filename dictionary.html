<style>
    th {
        text-align: left;
    }
    table {
        table-layout: fixed;
        width: 100%;
        border-collapse: collapse;
    }

    table tr:nth-child(even) {
        background-color: #fafafa;
    }

    tr {
        border-bottom-style: dashed;
        border-bottom-width: 1px;
        border-bottom-color: #ccc;
    }

    td {
        padding: 5px 5px 5px;
    }

    th {
        padding-left: 5px;
    }

    #input {
        height: 14pt;
    }
    #input {
        resize: none;
        overflow-y: hidden;
    }
    #output {
        max-height: 100%;
    }
    #container {
        overflow: auto;
        max-height: calc(100% - 102px);
    }

    #corner {
        position: absolute;
        right: 7px;
        top: 9px;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    #nav-inner {
        font-size: 15px;
    }

    input[type="checkbox"]:focus, #input:focus, button:focus {
        outline: none;
    }

    body {
        overflow-y: hidden;
        font-family: "Arial";
    }

    /* Dropdown container */
    .dropdown {
        position: relative;
        display: inline-block;
        font-size: 12px;
    }

    button {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        padding: 3px 8px;
        cursor: pointer;
        font-size: 12px;
    }

    /* Dropdown content */
    .dropdown-content {
        display: none;
        position: absolute;
        background-color: white;
        min-width: 200px;
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #ccc;
        z-index: 1;
        padding: 5px;
    }

    /* Show dropdown on button click */
    .dropdown.show .dropdown-content {
        display: block;
        user-select: none;
    }

    /* Style checkboxes */
    .dropdown-content input[type="checkbox"] {
        margin-right: 4px;
        transform: scale(0.85);
    }

    .dialect-specifier {
        font-size: 10px;
        vertical-align: super;
        cursor: help;
    }
</style>
<head>
    <script src="dictionary.js" type="module"></script>
</head>
<body>
    <div id="nav">
        <div id="corner">
            <button id="popout">Popout Dictionary</button>
        </div>
        <div id="nav-inner">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: -16px;">
                <span>Search:</span>
                <textarea id="input"></textarea>
            </div>

            <br>
            <span class="dialect-span">Dialect:</span>
            <input type="checkbox" id="dialect-standard" name="dialect" value="Standard" checked> <span class="dialect-span">Standard</span>
            <input type="checkbox" id="dialect-aatsilwi" name="dialect" value="A'atsilwi" checked> <span class="dialect-span">A'atsilwi</span>
            <br>
            <label for="swap" title="when checked, swaps from searching through the terms (english) to searching through the definitions (ngimëte)">Search through ngimëte instead</label>
            <input type="checkbox" id="swap" name="swap" value="swap" title="when checked, swaps from searching through the terms (english) to searching through the definitions (ngimëte)"><br>
            <label for="regex-search">Regex Search</label>
            <input type="checkbox" id="regex-search" name="regex-search" value="regex-search"><br>
            <label for="exclude-categories-dropdown">Exclude Categories:</label>
            <div id="exclude-categories-dropdown" class="dropdown">
                <button type="button" class="dropbtn" id="exclude-categories-button">Select Categories ▼</button>
                <div class="dropdown-content" id="exclude-categories">
                </div>
            </div>
            <button id="category-toggle">Toggle Categories</button>
        </div>
    </div>
    <div id="container">
        <table id="output"></table>
    </div>
</body>
<script type="module">
import { dict } from './dictionary.js';

const dropdown = document.getElementById("exclude-categories-dropdown");
const excludeCategoriesButton = document.getElementById("exclude-categories-button");
const dropbtn = dropdown.querySelector(".dropbtn");
const categoryToggleButton = document.getElementById("category-toggle");

const input = document.getElementById("input");
const output = document.getElementById("output");
const button = document.getElementById("popout");
const dialectCheckboxes = document.querySelectorAll('input[name="dialect"]');

const params = new URLSearchParams(window.location.search);

const excludedCategoriesParam = params.get("e");
const removeNav = Boolean(params.get("n"));
const removeCategoryColumn = params.get("c") === "true";
const dialectOverride = params.get("d");

if (params.get("b") === "false") button.style.display = "none";

if (removeNav) {
    document.getElementById("nav").style.display = "none";
    document.getElementById("container").style.maxHeight = "100%";
}

function getSelectedDialects() {
    if (dialectOverride) return [dialectOverride];

    return Array.from(dialectCheckboxes)
        .filter(d => d.checked)
        .map(d => d.value);
}

const defaultExcludedCategories = ["Consonant Sounds", "Vowel Sounds", "Connecting Letters", "Grammar", "Tenses"];

// Generate category checkboxes dynamically from dictionary
async function generateCategoryCheckboxes() {
    await dict.waitForDictLoad();

    const container = document.getElementById("exclude-categories");
    container.innerHTML = "";

    const categories = dict.practiceOrder

    categories.forEach(category => {
        const id = `exclude-${category.replace(/\s+/g, "-")}`;

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = "exclude-category";
        checkbox.value = category;
        checkbox.id = id;
        
        if(defaultExcludedCategories.includes(category)) checkbox.checked = true;

        const label = document.createElement("label");
        label.htmlFor = id;
        label.textContent = category;

        const wrapper = document.createElement("div");
        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);

        container.appendChild(wrapper);

        // Shift+Click behavior: check all other checkboxes
        checkbox.addEventListener("click", (e) => {
            // get how many checkboxes are checked
            updateCheckedBoxText();

            if (e.shiftKey) {
                const allCheckboxes = container.querySelectorAll('input[name="exclude-category"]');
                allCheckboxes.forEach(cb => {
                    if (cb !== checkbox) cb.checked = true;
                });
                e.target.checked = false;
                updateCheckedBoxText();
            }
        });
    });

    // Update dictionary when a checkbox is toggled
    container.querySelectorAll('input[name="exclude-category"]').forEach(cb =>
        cb.addEventListener("input", updateDictionary)
    );
}

function updateCheckedBoxText(){
    const container = document.getElementById("exclude-categories");
    const checkedBoxes = container.querySelectorAll('input[name="exclude-category"]:checked').length;

    if(checkedBoxes === 0) excludeCategoriesButton.innerText = "Select Categories ▼";
    else excludeCategoriesButton.innerText = `${checkedBoxes} Catagor${checkedBoxes == 1 ? "y" : "ies"} Excluded ▼`;
}

function getExcludedCategories(letterChecked) {
    const categories = [];

    // Excluded categories from URL
    if (excludedCategoriesParam) {
        categories.push(...excludedCategoriesParam.split("$"));
    }

    // Excluded categories from nav checkboxes
    const checkedBoxes = document.querySelectorAll('input[name="exclude-category"]:checked');
    checkedBoxes.forEach(cb => categories.push(cb.value));

    return categories;
}

const scriptConsonantVowelFix = {
    p: "ᨃ",
    b: "ᨃᨘ",
    t: "ᨈ",
    d: "ᨊ",
    "gy or ky": "ᨇ",
    k: "ᨍ",
    g: "ᨍᨘ",
    "'": "ᨀ",
    mb: "ᨌᨃᨛ",
    nd: "ᨌᨈᨛ",
    ngg: "ᨌᨍᨛ",
    m: "ᨅ",
    n: "ᨄ",
    ng: "ᨋ",
    f: "ᨂ",
    v: "ᨂᨘ",
    s: "ᨆ",
    h: "ᨀᨘ",
    ts: "ᨉ",
    w: "ᨏ",
    y: "ᨒ",
    l: "ᨓ",
    mbb: "ᨅᨃᨘ",
    ndd: "ᨄᨈᨘ",
    i: "ᨔᨗ",
    ü: "ᨔᨗᨛ",
    í: "ᨖᨗ",
    u: "ᨔᨗᨚ",
    ú: "ᨖᨗᨚ",
    e: "ᨔᨙ",
    é: "ᨖᨙ",
    ë: "ᨔᨛ",
    o: "ᨔᨚ",
    ó: "ᨖᨚ",
    a: "ᨔ",
    á: "ᨖ",
    ä: "ᨔᨘ",
    är: "ᨖᨘ"
}

const scriptConnectingLetterFix = {
    "letter group V": "N/A",
    "letter group C": "N/A",
    "letter group C1": "N/A",
    "letter group A": "N/A",
    "letter group D": "N/A",
    "letter group P": "N/A",
    "ā": "ᨔᨎ",
    "ə": "ᨎ",
    "c": "ᨎ",
    "z": "ᨎ"
}

function generateTable(results) {
    const hasCategory = !removeCategoryColumn;

    let table = `
        <tr style="position: sticky; top: 0px; background-color: white; user-select: none;">
            <td style="width: 50px; font-weight: bold;">#</td>
            <th>Word</th>
            <th>Definition</th>
            <th>Script</th>
            ${hasCategory ? "<th>Category</th>" : ""}
        </tr>
    `;

    if (results.length === 0) {
        table += `<tr><td colspan='${hasCategory ? 4 : 3}'>No results found</td></tr>`;
        return table;
    }

    const noDefIdentifier = "";

    for (let i = 0; i < results.length; i++) {
        const result = results[i];

        const definition = result.key
            .replaceAll(">", "&gt;")
            .replaceAll("<", "&lt;");

        // old
        // let preTerm = [...new Set(Object.values(result.value))];

        // new
        let preTerm = new Set(Object.values(result.value));
        preTerm = [...preTerm].filter(s => s !== noDefIdentifier);

        // †
        // ‡

        const standardIdentifier = "†";
        const aatsilwiIdentifier = "‡";

        const term = preTerm.join(" / ")
            .replaceAll(">", "&gt;")
            .replaceAll("<", "&lt;");

        const checkedDialects = Array.from(dialectCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        let scripts = [];

        if (checkedDialects.includes("Standard")) {
            scripts.push(result.script["Standard"].toString(1, undefined, ["script"]));
        }

        if (checkedDialects.includes("A'atsilwi")) {
            scripts.push(result.script["A'atsilwi"].toString(0, undefined, ["script"]));
        }

        // new
        let scriptCell = new Set(scripts);
        scriptCell = [...scriptCell].filter(s => s !== noDefIdentifier).join(" / ");

        // old
        // const scriptCell = [...new Set(scripts)].join(" / ");

        // this now works properly in a for loop
        if (term === "" && scriptCell === "") {
            continue;
        }

        const categoryCell = hasCategory ? `<td>${result.category}</td>` : "";

        if (result.category === "Consonant Sounds" || result.category === "Vowel Sounds") {
            scriptCell = scriptConsonantVowelFix[result.key];
        }

        if (result.category === "Connecting Letters") {
            scriptCell = scriptConnectingLetterFix[result.key];
        }

        let postFix = "";
        let specificity = '';

        // new
        if (result.value["Standard"] === noDefIdentifier && result.value["A'atsilwi"] !== noDefIdentifier) {
            postFix = aatsilwiIdentifier;
            specificity = "A&apos;atsilwi only";
        } else if (result.value["Standard"] !== noDefIdentifier && result.value["A'atsilwi"] === noDefIdentifier) {
            postFix = standardIdentifier;
            specificity = "Standard only";
        }

        table += `
            <tr>
                <td>${i + 1}.</td>
                <td>${definition}${postFix.length > 0 ? `<span class='dialect-specifier' title='${specificity}'>${postFix}</span>` : ""}</td>
                <td>${term}</td>
                <td>${scriptCell}</td>
                ${categoryCell}
            </tr>
        `;
    }

    return table;
}

async function updateDictionary() {
    const swap = document.getElementById("swap").checked;
    const regexSearch = document.getElementById("regex-search").checked;

    const dialects = getSelectedDialects();

    const options = {
        swap,
        excludedCategories: getExcludedCategories(),
        ...(regexSearch && { regexSearch: true }),
        ...(dialects.length !== 2 && { dialect: dialects[0] })
    };

    await dict.waitForDictLoad();
    const searchResult = dict.wordSearch(input.value, options);
    output.innerHTML = generateTable(searchResult.results);
}

// --- Event Listeners ---
[...document.querySelectorAll('input[type="checkbox"]'), input].forEach(el => {
    el.addEventListener("input", (e) => {
        if (e.key === "Enter") e.preventDefault();
        updateDictionary();
    });
});

button.addEventListener("click", () => dict.openDictionary("window"));


dropbtn.addEventListener("click", () => {
    dropdown.classList.toggle("show");
});

categoryToggleButton.addEventListener("click", () => {
    const checkboxes = dropdown.querySelectorAll('input[name="exclude-category"]');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
    });

    updateDictionary();
    updateCheckedBoxText();
});

// Close dropdown if clicked outside
window.addEventListener("click", (e) => {
    if (!dropdown.contains(e.target)) {
        if(e.target !== categoryToggleButton) dropdown.classList.remove("show");
    }
});

input.addEventListener("keydown", (e) => {
    if(e.key === "Enter") e.preventDefault();
});

// --- Initial Load ---
generateCategoryCheckboxes();
setTimeout(() => {
    updateDictionary();
    updateCheckedBoxText();
}, 250);
</script>